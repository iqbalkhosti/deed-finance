{% extends "base.html" %}

{% block title %}Spending Advisor{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 fw-bold">Spending Advisor</h1>
            <p class="text-muted mb-0">See which card to use and how many points you'll earn</p>
        </div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>

    {% if not user_cards %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        You haven't added any credit cards yet.
        <a href="{{ url_for('my_cards') }}" class="alert-link">Add a card</a> to get personalized advice.
    </div>
    {% else %}

    <div class="row g-4">
        <!-- Spending Input Section -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0"><i class="bi bi-cash-stack me-2 text-success"></i>Enter Your Monthly Spending</h5>
                </div>
                <div class="card-body">
                    <form id="spendingForm">
                        {% for category in categories %}
                        <div class="mb-3">
                            <label for="cat_{{ category.id }}" class="form-label">
                                <i class="bi {{ category.icon }} me-2"></i>{{ category.name }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control spending-input" id="cat_{{ category.id }}"
                                    data-category-id="{{ category.id }}" placeholder="0" min="0" step="10">
                            </div>
                            <small class="text-muted">{{ category.description }}</small>
                        </div>
                        {% endfor %}

                        <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                            <i class="bi bi-calculator me-2"></i>Calculate Points
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0"><i class="bi bi-lightbulb me-2 text-warning"></i>Recommendations</h5>
                </div>
                <div class="card-body" id="resultsSection">
                    <div class="text-center py-5 text-muted" id="emptyState">
                        <i class="bi bi-arrow-left-circle" style="font-size: 3rem;"></i>
                        <p class="mt-3 mb-0">Enter your spending amounts and click Calculate</p>
                    </div>

                    <!-- Results will be populated here -->
                    <div id="resultsContent" style="display: none;">
                        <!-- Card Recommendations -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">USE THESE CARDS</h6>
                            <div id="cardRecommendations"></div>
                        </div>

                        <!-- Total Points -->
                        <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="card-body text-white text-center py-4">
                                <p class="mb-1">Total Points Earned</p>
                                <h1 class="display-4 fw-bold mb-0" id="totalPointsDisplay">0</h1>
                            </div>
                        </div>

                        <!-- Subscription Coverage -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">SUBSCRIPTION COVERAGE</h6>
                            <div id="coverageResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.getElementById('spendingForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Collect spending data
        const spending = {};
        document.querySelectorAll('.spending-input').forEach(input => {
            const amount = parseFloat(input.value) || 0;
            if (amount > 0) {
                spending[input.dataset.categoryId] = amount;
            }
        });

        if (Object.keys(spending).length === 0) {
            alert('Please enter at least one spending amount.');
            return;
        }

        try {
            const response = await fetch('/calculate-points', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spending })
            });

            const data = await response.json();
            displayResults(data);
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        }
    });

    function displayResults(data) {
        // Hide empty state, show results
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('resultsContent').style.display = 'block';

        // Card recommendations
        const cardRecs = document.getElementById('cardRecommendations');
        cardRecs.innerHTML = data.results.map(r => `
    <div class="d-flex justify-content-between align-items-center p-3 border rounded mb-2">
      <div>
        <strong>${r.category}</strong>
        <br>
        <small class="text-muted">$${r.amount.toFixed(2)} spent</small>
      </div>
      <div class="text-end">
        <span class="badge bg-primary">${r.card}</span>
        <br>
        <span class="text-success fw-bold">+${r.points.toLocaleString()} pts</span>
        <small class="text-muted">(${r.rate}x)</small>
      </div>
    </div>
  `).join('');

        // Total points
        document.getElementById('totalPointsDisplay').textContent = data.total_points.toLocaleString();

        // Subscription coverage
        const coverageDiv = document.getElementById('coverageResults');
        if (data.coverage.length === 0) {
            coverageDiv.innerHTML = '<p class="text-muted">No subscriptions tracked. <a href="/my-subscriptions">Add some</a> to see coverage.</p>';
        } else {
            coverageDiv.innerHTML = data.coverage.map(c => `
      <div class="d-flex justify-content-between align-items-center p-3 border rounded mb-2 ${c.can_cover ? 'border-success bg-success bg-opacity-10' : ''}">
        <div>
          <strong>${c.name}</strong>
          <br>
          <small class="text-muted">$${c.cost.toFixed(2)}/month</small>
        </div>
        <div class="text-end">
          ${c.can_cover
                    ? '<span class="badge bg-success"><i class="bi bi-check-lg"></i> Can Cover!</span>'
                    : `<span class="badge bg-secondary">Need ${c.points_needed.toLocaleString()} pts</span>`}
        </div>
      </div>
    `).join('');
        }
    }
</script>
{% endblock %}